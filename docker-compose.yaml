x-api-env: &api-env
  - OPENID_DISCOVERY_URL=http://keycloak.${COMPOSE_DOMAIN:-mcm.localhost}/realms/dfsps
  - LOGIN_CALLBACK=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/callback
  - KEYCLOAK_BASE_URL=http://keycloak.${COMPOSE_DOMAIN:-mcm.localhost}
  - KEYCLOAK_DISCOVERY_URL=http://keycloak.${COMPOSE_DOMAIN:-mcm.localhost}/realms/dfsps/.well-known/openid-configuration
  - CLIENT_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}

x-api-labels: &api-labels
  - "traefik.http.routers.mcm-api.rule=Host(`${COMPOSE_DOMAIN:-mcm.localhost}`) && PathPrefix(`/api`)"
  - "traefik.http.services.mcm-api.loadbalancer.server.port=3001"

x-api-healthcheck: &api-healthcheck
  test: wget --spider --quiet http://localhost:3001/api/health
  interval: 5s
  timeout: 3s
  retries: 3
  start_period: 5s

configs:
  realm-template:
    file: ./docker/keycloak/dfsps-realm.json

volumes:
  keycloak-import: {}
  vault-data: {}
  vault-creds: {}
  mailpit-data: {}

services:

  traefik:
    image: traefik
    command:
      - --entrypoints.web.address=:80
      - --providers.docker=true
      - --api.dashboard=true
      - --api.insecure=true
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_DASHBOARD_PORT:-8090}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      default:
        aliases:
          - ${COMPOSE_DOMAIN:-mcm.localhost}
          - vault.${COMPOSE_DOMAIN:-mcm.localhost}
          - keycloak.${COMPOSE_DOMAIN:-mcm.localhost}
          - mailpit.${COMPOSE_DOMAIN:-mcm.localhost}
    restart: always

  connection-manager-ui:
    image: mojaloop/connection-manager-ui
    hostname: connection-manager-ui
    profiles:
      - dev
      - full
    environment:
      - AUTH_ENABLED=TRUE
      - API_BASE_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}
      - LOGIN_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/login
      - LOGOUT_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/logout
      - CHECK_SESSION_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/profile
    labels:
      - "traefik.http.routers.mcm-ui.rule=Host(`${COMPOSE_DOMAIN:-mcm.localhost}`) && !PathPrefix(`/api`)"
      - "traefik.http.services.mcm-ui.loadbalancer.server.port=8080"
    tty: true
    stdin_open: true
    restart: always

  connection-manager-migration:
    image: mojaloop/connection-manager-api:local
    pull_policy: if_not_present
    build:
      context: .
      dockerfile: Dockerfile
    profiles:
      - ci
    env_file:
      - ./docker/migration.env
    depends_on:
      connection-manager-db:
        condition: service_healthy
      vault-init:
        condition: service_completed_successfully
    volumes:
      - vault-creds:/vault
    command: npm run migrate
    restart: "no"

  connection-manager-migration-full:
    image: mojaloop/connection-manager-api
    profiles:
      - full
    env_file:
      - ./docker/migration.env
    depends_on:
      connection-manager-db:
        condition: service_healthy
      vault-init:
        condition: service_completed_successfully
    volumes:
      - vault-creds:/vault
    command: npm run migrate
    restart: "no"

  connection-manager-api-proxy:
    image: alpine/socat
    command: tcp-listen:${PORT:-3001},fork,reuseaddr tcp-connect:host.docker.internal:${PORT:-3001}
    profiles:
      - dev
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "traefik.http.routers.mcm-api.rule=Host(`${COMPOSE_DOMAIN:-mcm.localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.services.mcm-api.loadbalancer.server.port=${PORT:-3001}"

  connection-manager-api:
    image: mojaloop/connection-manager-api:local
    pull_policy: if_not_present
    build:
      context: .
      dockerfile: Dockerfile
    profiles:
      - ci
    env_file:
      - ./docker/api.env
    environment: *api-env
    labels: *api-labels
    volumes:
      - vault-creds:/vault
      - ./docker/mcm/resources:/resources:ro
    tty: true
    stdin_open: true
    restart: always
    depends_on:
      vault-init:
        condition: service_completed_successfully
      keycloak:
        condition: service_healthy
      connection-manager-migration:
        condition: service_completed_successfully
    healthcheck: *api-healthcheck

  connection-manager-api-full:
    image: mojaloop/connection-manager-api
    profiles:
      - full
    env_file:
      - ./docker/api.env
    environment: *api-env
    labels: *api-labels
    volumes:
      - vault-creds:/vault
      - ./docker/mcm/resources:/resources:ro
    tty: true
    stdin_open: true
    restart: always
    depends_on:
      vault-init:
        condition: service_completed_successfully
      keycloak:
        condition: service_healthy
      connection-manager-migration-full:
        condition: service_completed_successfully
    healthcheck: *api-healthcheck

  connection-manager-db:
    image: mysql:9
    ports:
      - "${DATABASE_PORT:-3306}:3306"
    volumes:
      - ./docker/sql-init/:/docker-entrypoint-initdb.d/
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-modus123}
      - MYSQL_USER=${DBUSER:-mcm}
      - MYSQL_PASSWORD=${DBPASS:-mcm}
      - MYSQL_DATABASE=${DBUSER:-mcm}
    healthcheck:
      test: ["CMD-SHELL", "mysql -h localhost -u$$MYSQL_USER -p$$MYSQL_PASSWORD -e 'SELECT 1'"]
      interval: 5s
      timeout: 3s
      retries: 20

  vault:
    image: hashicorp/vault:1.20
    command: server
    restart: always
    tty: true
    stdin_open: true
    environment:
      VAULT_ADDR: http://127.0.0.1:8233
      VAULT_API_ADDR: http://0.0.0.0:8233
      VAULT_LOCAL_CONFIG: '{"listener": [{"tcp": {"address": "0.0.0.0:8233", "tls_disable": true}}], "storage": {"file": {"path": "/vault/data"}}, "default_lease_ttl": "8760h", "max_lease_ttl": "87600h", "ui": true}'
    labels:
      - "traefik.http.routers.vault.rule=Host(`vault.${COMPOSE_DOMAIN:-mcm.localhost}`)"
      - "traefik.http.services.vault.loadbalancer.server.port=8233"
    volumes:
      - vault-data:/vault/data
      - vault-creds:/vault/creds
      - ./docker/vault/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://127.0.0.1:8233/v1/sys/health?sealedcode=200&uninitcode=200"]
      interval: 3s
      timeout: 2s
      retries: 10
      start_period: 3s

  vault-init:
    build:
      context: ./docker/vault
      dockerfile_inline: |
        FROM alpine:latest
        RUN apk add --no-cache curl jq
    environment:
      VAULT_ADDR: http://vault:8233
    volumes:
      - vault-data:/vault/data
      - vault-creds:/vault/creds
      - ./docker/vault/vault-init.sh:/vault-init.sh
    depends_on:
      vault:
        condition: service_healthy
    entrypoint: /vault-init.sh
    restart: "no"

  volume_explorer:
    image: alpine
    command: sh -c 'cp -r /vault/creds/. /creds/ && tail -f /dev/null'
    volumes:
      - vault-creds:/vault/creds:ro
      - ./docker/vault/tmp:/creds:rw
    depends_on:
      vault-init:
        condition: service_completed_successfully
    restart: "no"
    profiles:
      - dev
      - ci

  mailpit:
    image: axllent/mailpit:latest
    labels:
      - "traefik.http.routers.mailpit.rule=Host(`mailpit.${COMPOSE_DOMAIN:-mcm.localhost}`)"
      - "traefik.http.services.mailpit.loadbalancer.server.port=8025"
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8025/api/v1/info"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  prepare-keycloak-realm:
    image: steinbrueckri/envsubst
    working_dir: /work
    configs:
      - source: realm-template
        target: /template/dfsps-realm.json.template
        mode: 0444
    volumes:
      - keycloak-import:/work
    env_file:
      - ./docker/keycloak/dfsp-realm.env
    entrypoint: |
      sh -c '
        echo "Rendering realm import ..."
        envsubst < /template/dfsps-realm.json.template > /work/dfsps-realm.json
      '
    restart: "no"

  keycloak:
    image: keycloak/keycloak:26.3
    command: start-dev --import-realm
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin
      - KC_HEALTH_ENABLED=true
      - KC_HOSTNAME=keycloak.${COMPOSE_DOMAIN:-mcm.localhost}
      - KC_HOSTNAME_STRICT=true
    labels:
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.${COMPOSE_DOMAIN:-mcm.localhost}`)"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
    volumes:
      - keycloak-import:/opt/keycloak/data/import
    depends_on:
      mailpit:
        condition: service_healthy
      prepare-keycloak-realm:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/9000;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;timeout 1 cat <&3 | grep -q UP"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
